# 当前脚本存在问题，在 Github Action 执行构建时，TypeScript 是完全静态的
# 导致一些需要运行时判断的类型检查错误，如 @/db 中根据 env.DB_DRIVER 来判断使用哪个数据库驱动
# 过段时间再来解决这个问题，目前先本地手动构建 docker 镜像并推送

name: Build and Push Docker Image

on:
  push:
    branches:
      - main
  # 仅支持手动触发
  # workflow_dispatch: {}

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            ${{ secrets.DOCKER_USERNAME }}/bmm:latest
            ${{ secrets.DOCKER_USERNAME }}/bmm:${{ github.sha }}
